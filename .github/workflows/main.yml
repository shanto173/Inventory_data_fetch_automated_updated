name: Odoo Stock Report Automation

on:
  workflow_dispatch:
    inputs:
      run_Closing_stock:
        description: 'Run Closing_stock.py'
        type: boolean
        default: false
      run_Raw_materials:
        description: 'Run Raw_materials.py'
        type: boolean
        default: false
      run_pending_slider:
        description: 'Run pending_slider.py'
        type: boolean
        default: false
      run_inventory_ageing:
        description: 'Run inventory_ageing.py'
        type: boolean
        default: false
      run_inovice_summary:
        description: 'Run inovice_summary.py'
        type: boolean
        default: false
      run_Relese_inovice_summary:
        description: 'Run Relese_inovice_summary.py'
        type: boolean
        default: false
      run_Consumption_stock_mar24_till:
        description: 'Run Consumption_stock_mar24_till.py'
        type: boolean
        default: false
      run_Consumption_stock_Apr24_till:
        description: 'Run Consumption_stock_Apr24_till.py'
        type: boolean
        default: false
      run_Sep_inovice_summary:
        description: 'Run Sep_inovice_summary.py'
        type: boolean
        default: false
      run_pending_invoice_last_month:
        description: 'Run pending_invoice_last_month.py'
        type: boolean
        default: false
      run_all:
        description: 'Run ALL scripts (overrides individual toggles)'
        type: boolean
        default: false

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python modules
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas gspread gspread-dataframe google-auth google-auth-oauthlib google-auth-httplib2 selenium webdriver-manager openpyxl pytz python-dotenv

      - name: Decode Google credentials
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}" | base64 --decode > gcreds.json

      - name: Run selected scripts
        run: |
          # Define all scripts
          ALL_SCRIPTS=(
            "Closing_stock.py"
            "Raw_materials.py"
            "pending_slider.py"
            "inventory_ageing.py"
            "inovice_summary.py"
            "Relese_inovice_summary.py"
            "Consumption_stock_mar24_till.py"
            "Consumption_stock_Apr24_till.py"
            "Sep_inovice_summary.py"
            "pending_invoice_last_month.py"
          )

          # Prepare array of scripts to run
          SCRIPTS_TO_RUN=()

          if [ "${{ github.event.inputs.run_all }}" == "true" ]; then
            SCRIPTS_TO_RUN=("${ALL_SCRIPTS[@]}")
          else
            [ "${{ github.event.inputs.run_Closing_stock }}" == "true" ] && SCRIPTS_TO_RUN+=("Closing_stock.py")
            [ "${{ github.event.inputs.run_Raw_materials }}" == "true" ] && SCRIPTS_TO_RUN+=("Raw_materials.py")
            [ "${{ github.event.inputs.run_pending_slider }}" == "true" ] && SCRIPTS_TO_RUN+=("pending_slider.py")
            [ "${{ github.event.inputs.run_inventory_ageing }}" == "true" ] && SCRIPTS_TO_RUN+=("inventory_ageing.py")
            [ "${{ github.event.inputs.run_inovice_summary }}" == "true" ] && SCRIPTS_TO_RUN+=("inovice_summary.py")
            [ "${{ github.event.inputs.run_Relese_inovice_summary }}" == "true" ] && SCRIPTS_TO_RUN+=("Relese_inovice_summary.py")
            [ "${{ github.event.inputs.run_Consumption_stock_mar24_till }}" == "true" ] && SCRIPTS_TO_RUN+=("Consumption_stock_mar24_till.py")
            [ "${{ github.event.inputs.run_Consumption_stock_Apr24_till }}" == "true" ] && SCRIPTS_TO_RUN+=("Consumption_stock_Apr24_till.py")
            [ "${{ github.event.inputs.run_Sep_inovice_summary }}" == "true" ] && SCRIPTS_TO_RUN+=("Sep_inovice_summary.py")
            [ "${{ github.event.inputs.run_pending_invoice_last_month }}" == "true" ] && SCRIPTS_TO_RUN+=("pending_invoice_last_month.py")
          fi

          # Run each selected script
          for SCRIPT in "${SCRIPTS_TO_RUN[@]}"; do
            echo "â–¶ Running $SCRIPT..."
            python "$SCRIPT"
          done
        env:
          ODOO_URL: ${{ secrets.ODOO_URL }}
          ODOO_DB: ${{ secrets.ODOO_DB }}
          ODOO_USERNAME: ${{ secrets.ODOO_USERNAME }}
          ODOO_PASSWORD: ${{ secrets.ODOO_PASSWORD }}
          FROM_DATE: ${{ env.FROM_DATE }}
          TO_DATE: ${{ env.TO_DATE }}
